<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RTSP Live Stream Viewer | StreamVision</title>
    <meta
      name="description"
      content="StreamVision - View your RTSP camera feeds live with a powerful, modern, and secure web viewer."
    />
    <meta
      name="keywords"
      content="RTSP, CCTV, Live Stream, IP Camera, HLS, FFmpeg, Viewer, StreamVision"
    />
    <meta name="author" content="Amrit, Developer of StreamVision" />

    <link rel="canonical" href="https://cctvcameralive.in/" />
    <meta name="robots" content="index, follow" />
    <meta property="og:title" content="StreamVision | RTSP Live CCTV Viewer" />
    <meta
      property="og:description"
      content="Real-time RTSP CCTV camera streaming using HLS and analytics."
    />
    <meta
      property="og:image"
      content="https://cctvcameralive.in/images/banner.svg"
    />
    <meta property="og:url" content="https://cctvcameralive.in" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="StreamVision | RTSP Live CCTV Viewer" />
    <meta
      name="twitter:description"
      content="Real-time RTSP CCTV camera streaming using HLS and analytics."
    />
    <meta
      name="twitter:image"
      content="https://cctvcameralive.in/images/banner.svg"
    />

    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/site.webmanifest" />

    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/css/style.css" nonce="<%= nonce %>" />

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"
      defer
    ></script>

    <script
      src="https://cdn.jsdelivr.net/npm/flowbite@1.4.0/dist/flowbite.min.js"
      defer
      nonce="<%= nonce %>"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/hls.js@latest"
      defer
      nonce="<%= nonce %>"
    ></script>

    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate, max-age=0"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
      /* Simple style for the loader */
      .loader {
        border-top-color: #3b82f6; /* Updated to blue */
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
      }
      @-webkit-keyframes spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body
    class="dark:bg-slate-900 font-sans text-slate-800 dark:text-slate-200 antialiased overflow-x-hidden"
  >
    <video
      id="earth"
      autoplay
      loop
      muted
      playsinline
      class="absolute dark:block top-9 h-screen w-screen -z-20 object-cover opacity-20 overflow-hidden"
    >
      <source src="/images/earth.mp4" type="video/mp4" />
      Your browser does not support the video tag.
    </video>

    <header
      class="sticky top-0 z-50 w-full bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="/" class="flex items-center space-x-3">
            <img
              src="/images/favicon.png"
              class="h-8"
              alt="StreamVision Logo"
            />
            <span class="text-2xl font-bold text-slate-900 dark:text-white"
              >StreamVision</span
            >
          </a>
          <div class="flex items-center space-x-4">
            <button
              id="theme-toggle"
              type="button"
              class="p-2 rounded-lg text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <svg
                id="theme-toggle-dark-icon"
                class="hidden w-5 h-5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                ></path>
              </svg>
              <svg
                id="theme-toggle-light-icon"
                class="hidden w-5 h-5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </button>
            <a
              href="/login"
              class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900 transition-colors"
            >
              Admin Login
            </a>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section class="relative py-20">
        <div
          class="absolute inset-x-0 -top-40 -z-10 transform-gpu overflow-hidden blur-3xl sm:-top-80"
          aria-hidden="true"
        >
          <div
            class="relative left-[calc(50%-11rem)] aspect-[1155/678] w-[36.125rem] -translate-x-1/2 rotate-[30deg] bg-gradient-to-tr from-[#38bdf8] to-[#6366f1] opacity-20 sm:left-[calc(50%-30rem)] sm:w-[72.1875rem]"
            style="
              clip-path: polygon(
                74.1% 44.1%,
                100% 61.6%,
                97.5% 26.9%,
                85.5% 0.1%,
                80.7% 2%,
                72.5% 32.5%,
                60.2% 62.4%,
                52.4% 68.1%,
                47.5% 58.3%,
                45.2% 34.5%,
                27.5% 76.7%,
                0.1% 64.9%,
                17.9% 100%,
                27.6% 76.8%,
                76.1% 97.7%,
                74.1% 44.1%
              );
            "
          ></div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <a
            href="/updates"
            class="inline-flex flex-col sm:flex-row justify-between items-center py-2 px-3 sm:py-1 sm:px-1 pe-4 mb-7 text-xs sm:text-sm text-green-700 bg-green-100 rounded-full dark:bg-green-900 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-800"
          >
            <span
              class="text-xs bg-green-600 rounded-full text-white px-3 py-1 sm:px-4 sm:py-1.5 me-0 sm:me-3 mb-1 sm:mb-0"
              >Update</span
            >
            <span
              class="text-xs sm:text-sm font-medium text-center sm:text-left"
              >StreamVision v2.0 is live! Check out the new features ðŸš€</span
            >
            <svg
              class="w-2 h-2 sm:w-2.5 sm:h-2.5 ms-0 sm:ms-2 rtl:rotate-180"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 6 10"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m1 9 4-4-4-4"
              />
            </svg>
          </a>
          <h1
            class="text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white sm:text-5xl lg:text-6xl gsap-reveal"
          >
            Live RTSP Stream Viewer
          </h1>
          <p
            class="mt-6 max-w-2xl mx-auto text-lg text-slate-600 dark:text-slate-400 gsap-reveal"
          >
            Simply paste your camera's RTSP URL below to start viewing the live
            feed securely in your browser.
          </p>

          <div
            class="mt-12 max-w-3xl mx-auto bg-white/80 dark:bg-slate-800/50 backdrop-blur-sm rounded-2xl shadow-2xl shadow-slate-200/50 dark:shadow-black/20 p-6 sm:p-8 border border-slate-200 dark:border-slate-700 gsap-reveal"
          >
            <div class="flex flex-col sm:flex-row items-center gap-4">
              <input
                type="text"
                id="rtspInput"
                class="w-full px-4 py-3 text-base bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-white border-2 border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="rtsp://user:pass@ip_address:port/stream"
              />
              <button
                id="playBtn"
                class="flex-shrink-0 w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 text-base font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <svg
                  class="w-5 h-5 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Start Stream
              </button>
              <button
                id="stopBtn"
                class="hidden flex-shrink-0 w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 text-base font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900 transition-colors"
              >
                <svg
                  class="w-5 h-5 mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                Stop Stream
              </button>
            </div>

            <div
              id="videoContainer"
              class="hidden mt-6 aspect-video bg-black rounded-lg overflow-hidden relative"
            >
              <div
                id="loader"
                class="hidden absolute inset-0 flex items-center justify-center"
              >
                <div
                  class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"
                ></div>
              </div>
              <video
                id="videoPlayer"
                width="100%"
                controls
                class="w-full h-full hidden"
              ></video>
            </div>
          </div>
        </div>
      </section>

      <section
        id="features"
        class="py-20 sm:py-24 lg:py-32 bg-white dark:bg-slate-950/20"
      >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center">
            <h2
              class="text-base font-semibold leading-7 text-blue-600 dark:text-blue-400 gsap-reveal"
            >
              Why Choose StreamVision?
            </h2>
            <p
              class="mt-2 text-3xl font-bold tracking-tight text-slate-900 dark:text-white sm:text-4xl gsap-reveal"
            >
              Everything You Need for Modern Surveillance
            </p>
            <p
              class="mt-6 max-w-2xl mx-auto text-lg leading-8 text-slate-600 dark:text-slate-400 gsap-reveal"
            >
              From low-latency viewing to secure sharing, we provide a robust
              platform for all your streaming needs.
            </p>
          </div>
          <div
            class="mt-16 grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3"
          >
            <div
              class="p-8 bg-slate-100/50 dark:bg-slate-800/50 rounded-xl gsap-reveal"
            >
              <div
                class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-lg"
              >
                <svg
                  class="w-7 h-7"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <h3 class="mt-5 text-xl font-bold text-slate-900 dark:text-white">
                Low-Latency Streaming
              </h3>
              <p class="mt-2 text-base text-slate-600 dark:text-slate-400">
                Monitor multiple RTSP streams in real-time with ultra-low
                latency, powered by HLS and FFmpeg.
              </p>
            </div>
            <div
              class="p-8 bg-slate-100/50 dark:bg-slate-800/50 rounded-xl gsap-reveal"
            >
              <div
                class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-lg"
              >
                <svg
                  class="w-7 h-7"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                  ></path>
                </svg>
              </div>
              <h3 class="mt-5 text-xl font-bold text-slate-900 dark:text-white">
                Public Shareable Links
              </h3>
              <p class="mt-2 text-base text-slate-600 dark:text-slate-400">
                Create time-bound public HLS stream URLs for quick sharing with
                external stakeholders without requiring a login.
              </p>
            </div>
            <div
              class="p-8 bg-slate-100/50 dark:bg-slate-800/50 rounded-xl gsap-reveal"
            >
              <div
                class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-lg"
              >
                <svg
                  class="w-7 h-7"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                  ></path>
                </svg>
              </div>
              <h3 class="mt-5 text-xl font-bold text-slate-900 dark:text-white">
                Secure and Encrypted
              </h3>
              <p class="mt-2 text-base text-slate-600 dark:text-slate-400">
                All data and video streams are protected with SSL/HTTPS
                encryption and robust security policies like CSP and Helmet.
              </p>
            </div>
          </div>
        </div>
      </section>

      <section class="py-20 sm:py-24">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h2
            class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white sm:text-4xl gsap-reveal"
          >
            About the Developer
          </h2>
          <p
            class="mt-4 text-lg text-slate-600 dark:text-slate-400 gsap-reveal"
          >
            StreamVision is developed and maintained by a passionate software
            engineer dedicated to building high-quality, real-time video
            solutions.
          </p>
        </div>
        <div
          class="mt-16 max-w-sm mx-auto bg-white dark:bg-slate-800/50 rounded-2xl shadow-lg p-8 text-center border border-slate-200 dark:border-slate-700 gsap-reveal"
        >
          <img
            class="w-24 h-24 rounded-full mx-auto"
            src="https://avatars.githubusercontent.com/u/35948782?v=4"
            alt="Amrit Sharma profile picture"
          />
          <div class="mt-4">
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white">
              Amrit Sharma
            </h3>
            <p class="text-blue-600 dark:text-blue-400">Full-Stack Developer</p>
            <p class="mt-2 text-slate-600 dark:text-slate-400">
              Specializing in Node.js, FFmpeg, and real-time streaming
              technologies to create secure and scalable surveillance platforms.
            </p>
          </div>
          <div class="mt-6 flex justify-center space-x-5">
            <a
              href="https://github.com/CodeByAmrit/"
              target="_blank"
              class="text-slate-400 hover:text-slate-500 dark:hover:text-slate-300"
            >
              <span class="sr-only">GitHub</span>
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16">
                <path
                  d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                />
              </svg>
            </a>
            <a
              href="https://www.linkedin.com/in/amrit-sharma-b11b88124/"
              target="_blank"
              class="text-slate-400 hover:text-slate-500 dark:hover:text-slate-300"
            >
              <span class="sr-only">LinkedIn</span>
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16">
                <path
                  d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"
                />
              </svg>
            </a>
          </div>
        </div>
      </section>
    </main>

    <footer
      class="bg-white dark:bg-slate-950/20 border-t border-slate-200 dark:border-slate-800"
    >
      <div
        class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 md:flex md:items-center md:justify-between"
      >
        <div
          class="text-center text-sm text-slate-500 dark:text-slate-400 md:text-left"
        >
          &copy; 2025
          <a href="/" class="hover:underline">StreamVisionâ„¢</a>. All Rights
          Reserved.
        </div>
        <ul class="flex justify-center mt-4 space-x-6 md:mt-0 md:order-2">
          <li>
            <a
              href="#"
              class="text-sm text-slate-500 dark:text-slate-400 hover:underline"
              >About</a
            >
          </li>
          <li>
            <a
              href="#"
              class="text-sm text-slate-500 dark:text-slate-400 hover:underline"
              >Privacy</a
            >
          </li>
          <li>
            <a
              href="#"
              class="text-sm text-slate-500 dark:text-slate-400 hover:underline"
              >Contact</a
            >
          </li>
        </ul>
      </div>
    </footer>

    <script nonce="<%= nonce %>">
      // --- Element Selectors ---
      const rtspInput = document.getElementById("rtspInput");
      const playBtn = document.getElementById("playBtn");
      const stopBtn = document.getElementById("stopBtn");
      const videoContainer = document.getElementById("videoContainer"); // Container for player and loader
      const loader = document.getElementById("loader");
      const video = document.getElementById("videoPlayer");
      let currentRtspUrl = "";
      let hls = null; // To hold the HLS instance

      // --- Autoplay from URL Parameter ---
      window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const rtsp = params.get("rtsp");
        if (rtsp) {
          rtspInput.value = rtsp;
          playBtn.click();
        }
      });

      // --- Main Play Logic ---
      playBtn.addEventListener("click", async function () {
        const rtspUrl = rtspInput.value.trim();

        if (!rtspUrl.startsWith("rtsp://")) {
          alert("Please enter a valid RTSP link starting with rtsp://");
          return;
        }

        // Show the video container and loader
        videoContainer.classList.remove("hidden");
        loader.classList.remove("hidden");
        video.classList.add("hidden");
        playBtn.disabled = true;

        try {
          const response = await fetch("/api/start-stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rtspUrl }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to start stream");
          }

          const data = await response.json();
          const hlsUrl = data.hlsUrl;
          if (!hlsUrl) throw new Error("No HLS URL returned from server");

          currentRtspUrl = rtspUrl;
          loadHlsStream(hlsUrl);
        } catch (err) {
          console.error("Error starting stream:", err);
          alert(`Failed to start stream: ${err.message}`);
          resetPlayerUI(true); // Reset UI and hide container on error
        }
      });

      // --- HLS Stream Loading with Retry ---
      function loadHlsStream(hlsUrl) {
        const maxAttempts = 8;
        let attempts = 0;

        const tryLoad = async () => {
          try {
            // Check if the manifest file is available
            const probe = await fetch(hlsUrl, { method: "HEAD" });
            if (probe.ok) {
              loader.classList.add("hidden");
              video.classList.remove("hidden");
              stopBtn.classList.remove("hidden");
              playBtn.disabled = false;

              if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
              } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                video.src = hlsUrl;
                video.addEventListener("loadedmetadata", () => video.play());
              } else {
                alert("HLS is not supported in this browser.");
                resetPlayerUI(true);
              }
              return; // Success, so exit the retry loop
            }
          } catch (e) {
            // This error is expected while waiting for the file, so we ignore it and retry
          }

          // If not successful, retry after a delay
          if (++attempts < maxAttempts) {
            setTimeout(tryLoad, 2000);
          } else {
            alert(
              "Stream not ready after multiple attempts. Please check the RTSP URL or try again later."
            );
            resetPlayerUI(true); // Reset UI and hide container on failure
          }
        };

        tryLoad();
      }

      // --- Stop Button Logic ---
      stopBtn.addEventListener("click", async function () {
        if (!currentRtspUrl) return;

        try {
          const response = await fetch("/api/stop-stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rtspUrl: currentRtspUrl }),
          });
          if (response.ok) {
            resetPlayerUI(true);
          } else {
            const result = await response.json();
            alert(result.error || "Failed to stop the stream.");
          }
        } catch (err) {
          console.error("Error stopping stream:", err);
          alert("An error occurred while trying to stop the stream.");
        }
      });

      // --- UI Reset Function ---
      function resetPlayerUI(hideContainer = false) {
        // Destroy HLS instance if it exists to free up resources
        if (hls) {
          hls.destroy();
          hls = null;
        }
        video.pause();
        video.src = "";
        video.classList.add("hidden");
        stopBtn.classList.add("hidden");
        loader.classList.add("hidden");
        playBtn.disabled = false;
        currentRtspUrl = "";

        if (hideContainer) {
          videoContainer.classList.add("hidden");
        }
      }
    </script>
    <script nonce="<%= nonce %>">
      // --- GSAP Scroll Animations ---
      document.addEventListener("DOMContentLoaded", () => {
        // Wait for GSAP and ScrollTrigger to be available
        if (typeof gsap !== "undefined" && typeof ScrollTrigger !== "undefined") {
          gsap.registerPlugin(ScrollTrigger);

          // Find all elements with the 'gsap-reveal' class and animate them
          gsap.utils.toArray(".gsap-reveal").forEach((elem) => {
            gsap.from(elem, {
              scrollTrigger: {
                trigger: elem,
                start: "top 85%", // Animation starts when the top of the element is 85% from the top of the viewport
                toggleActions: "play none none none", // Play the animation once when it enters and do nothing else
              },
              opacity: 0,
              y: 50, // Start 50px below its final position
              duration: 1,
              ease: "power3.out",
            });
          });
        }
      });
    </script>

    <script src="/js/theme.js" nonce="<%= nonce %>"></script>
  </body>
</html>