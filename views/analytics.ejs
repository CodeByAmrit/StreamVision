<!DOCTYPE html>
<html lang="en" class="dark">
  <%- include('./partials/header.ejs', { title: "Analytics Dashboard | StreamVision", keywords:
  "stream analytics, CCTV statistics, surveillance metrics, live stream monitoring", description:
  "Comprehensive analytics and monitoring dashboard for your StreamVision surveillance system" }) %>

  <body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Loading Screen -->
    <div
      id="introScreen"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-blue-50 to-white dark:from-gray-900 dark:to-gray-800"
    >
      <div class="text-center">
        <div class="relative w-64 h-64">
          <div
            class="absolute inset-0 bg-gradient-to-r from-[#63b3ed] to-[#3182ce] rounded-full opacity-20 animate-pulse"
          ></div>
          <div class="relative w-full h-full flex items-center justify-center">
            <div class="text-center">
              <div class="text-4xl font-bold gradient-text mb-4">StreamVision</div>
              <div class="text-blue-600 dark:text-blue-400 text-sm font-medium">
                Loading analytics dashboard...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Navigation -->
    <%- include('./partials/navbar.ejs', {activePage: 'analytics'}) %>

    <!-- Top Navigation Bar -->
    <%- include('./partials/topMenu.ejs', { title: "Analytics Dashboard", user: user }) %>

    <!-- Main Content -->
    <main class="p-6 sm:ml-64 mt-16 min-h-screen bg-gray-50/50 dark:bg-gray-900/50">
      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
              Analytics
              <span class="gradient-text">Dashboard</span>
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">
              Comprehensive insights and performance metrics for your streaming infrastructure
            </p>
          </div>
          <div class="flex items-center space-x-3">
            <div class="hidden md:block text-right">
              <p class="text-sm text-gray-500 dark:text-gray-400">Last Updated</p>
              <p class="text-lg font-bold text-blue-600 dark:text-blue-400" id="last-updated">
                Just now
              </p>
            </div>
            <button
              id="refresh-analytics"
              class="p-3 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800/50 transition-colors"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total DVRs -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6 card-hover"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Total DVRs</p>
              <h3 class="text-3xl font-bold text-gray-900 dark:text-white">
                <%= typeof total_dvrs !== "undefined" ? total_dvrs : 0 %>
              </h3>
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                <i class="fas fa-building mr-1"></i>
                Surveillance locations
              </p>
            </div>
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-blue-50 dark:from-blue-900/30 dark:to-blue-800/20 flex items-center justify-center"
            >
              <i class="fas fa-server text-blue-600 dark:text-blue-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-blue-50 dark:border-gray-700">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">
                Online:
                <span class="font-semibold text-green-600 dark:text-green-400">
                  <%= activeDvrs?.length || 0 %>
                </span>
              </span>
              <span class="text-gray-600 dark:text-gray-400">
                Offline:
                <span class="font-semibold text-red-600 dark:text-red-400">
                  <%= total_dvrs - activeDvrs.length %>
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- Total Cameras -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6 card-hover"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Total Cameras</p>
              <h3 class="text-3xl font-bold text-gray-900 dark:text-white"><%= total_cameras %></h3>
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                <i class="fas fa-video mr-1"></i>
                Connected devices
              </p>
            </div>
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-100 to-purple-50 dark:from-purple-900/30 dark:to-purple-800/20 flex items-center justify-center"
            >
              <i class="fas fa-camera text-purple-600 dark:text-purple-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-blue-50 dark:border-gray-700">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">
                Active:
                <span class="font-semibold text-green-600 dark:text-green-400">
                  <%= active_streams %>
                </span>
              </span>
              <span class="text-gray-600 dark:text-gray-400">
                Inactive:
                <span class="font-semibold text-gray-600 dark:text-gray-400">
                  <%= (total_cameras || 0) - (active_streams || 0) %>
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- Active Streams -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6 card-hover"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Active Streams</p>
              <h3 class="text-3xl font-bold text-gray-900 dark:text-white">
                <%= active_streams %>
              </h3>
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                <i class="fas fa-broadcast-tower mr-1"></i>
                Currently streaming
              </p>
            </div>
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-100 to-green-50 dark:from-green-900/30 dark:to-green-800/20 flex items-center justify-center"
            >
              <i class="fas fa-wifi text-green-600 dark:text-green-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-blue-50 dark:border-gray-700">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              <i class="fas fa-chart-line text-blue-500 mr-1"></i>
              Real-time monitoring
            </div>
          </div>
        </div>

        <!-- Uptime -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6 card-hover"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">System Uptime</p>
              <h3 class="text-3xl font-bold text-gray-900 dark:text-white">99.8%</h3>
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                <i class="fas fa-clock mr-1"></i>
                Last 30 days
              </p>
            </div>
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-100 to-orange-50 dark:from-orange-900/30 dark:to-orange-800/20 flex items-center justify-center"
            >
              <i class="fas fa-chart-pie text-orange-600 dark:text-orange-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-blue-50 dark:border-gray-700">
            <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
              <div
                class="bg-gradient-to-r from-green-400 to-green-500 h-2 rounded-full"
                style="width: 99.8%"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Analytics Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Streams per DVR Chart -->
        <div class="lg:col-span-2">
          <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6"
          >
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                  Streams Distribution per DVR
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                  Active streams across different surveillance locations
                </p>
              </div>
              <div class="flex items-center space-x-3">
                <select
                  id="time-range"
                  class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-blue-200 dark:border-gray-600 rounded-xl text-sm text-gray-900 dark:text-white"
                >
                  <option value="realtime">Real-time</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                </select>
                <button
                  class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm font-medium"
                >
                  <i class="fas fa-download mr-1"></i>
                  Export
                </button>
              </div>
            </div>
            <div class="h-80">
              <canvas id="dvrStreamsChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Camera Status Distribution -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6"
        >
          <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Camera Status</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Distribution of active vs inactive cameras
            </p>
          </div>
          <div class="h-64">
            <canvas id="cameraStatusChart"></canvas>
          </div>
          <div class="mt-6 pt-6 border-t border-blue-50 dark:border-gray-700">
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400">
                  <%= active_streams %>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Active Cameras</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-gray-600 dark:text-gray-400">
                  <%= (total_cameras || 0) - (active_streams || 0) %>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Inactive Cameras</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Streaming Performance -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6"
        >
          <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Streaming Performance</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Bandwidth usage and stream quality metrics
            </p>
          </div>
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  Bandwidth Usage
                </span>
                <span class="text-sm font-bold text-blue-600 dark:text-blue-400">2.4 Gbps</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                <div
                  class="bg-gradient-to-r from-blue-400 to-blue-500 h-2 rounded-full"
                  style="width: 78%"
                ></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  Stream Quality
                </span>
                <span class="text-sm font-bold text-green-600 dark:text-green-400">92% HD</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                <div
                  class="bg-gradient-to-r from-green-400 to-green-500 h-2 rounded-full"
                  style="width: 92%"
                ></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Latency</span>
                <span class="text-sm font-bold text-green-600 dark:text-green-400">120ms</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                <div
                  class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-2 rounded-full"
                  style="width: 45%"
                ></div>
              </div>
            </div>
          </div>
          <div class="mt-6 pt-6 border-t border-blue-50 dark:border-gray-700">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              <i class="fas fa-info-circle text-blue-500 mr-2"></i>
              Optimal performance range: &lt;200ms latency
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Analytics Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Top Active DVRs -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 overflow-hidden"
        >
          <div class="px-6 py-4 border-b border-blue-50 dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Top Active DVRs</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              DVRs with highest streaming activity
            </p>
          </div>
          <div class="divide-y divide-blue-50 dark:divide-gray-700">
            <% if (activeDvrs && activeDvrs.length > 0) { %> <% activeDvrs.slice(0, 5).forEach((dvr,
            index) => { %>
            <div class="px-6 py-4 hover:bg-blue-50/30 dark:hover:bg-gray-700/30 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div
                    class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-100 to-blue-50 dark:from-blue-900/30 dark:to-blue-800/20 flex items-center justify-center"
                  >
                    <span class="text-blue-600 dark:text-blue-400 font-bold"><%= index + 1 %></span>
                  </div>
                  <div>
                    <h4 class="font-bold text-gray-900 dark:text-white"><%= dvr.dvr_name %></h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400"><%= dvr.location_name %></p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold text-green-600 dark:text-green-400">
                    <%= dvr.activeCameraCount || 0 %> streams
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Active now</div>
                </div>
              </div>
            </div>
            <% }); %> <% } else { %>
            <div class="px-6 py-8 text-center">
              <div
                class="w-12 h-12 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center mx-auto mb-4"
              >
                <i class="fas fa-chart-line text-gray-400"></i>
              </div>
              <p class="text-gray-600 dark:text-gray-400">No active streaming data available</p>
            </div>
            <% } %>
          </div>
        </div>

        <!-- System Health -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 p-6"
        >
          <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">System Health</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Current system performance metrics
            </p>
          </div>
          <div class="space-y-4">
            <div
              class="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/10 border border-green-200 dark:border-green-800"
            >
              <div class="flex items-center">
                <div
                  class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3"
                >
                  <i class="fas fa-check text-green-600 dark:text-green-400"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-900 dark:text-white">Server Load</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Normal (42%)</div>
                </div>
              </div>
              <div class="text-2xl font-bold text-green-600 dark:text-green-400">✓</div>
            </div>

            <div
              class="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/10 border border-green-200 dark:border-green-800"
            >
              <div class="flex items-center">
                <div
                  class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3"
                >
                  <i class="fas fa-database text-green-600 dark:text-green-400"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-900 dark:text-white">Database</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Connected</div>
                </div>
              </div>
              <div class="text-2xl font-bold text-green-600 dark:text-green-400">✓</div>
            </div>

            <div
              class="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/10 border border-yellow-200 dark:border-yellow-800"
            >
              <div class="flex items-center">
                <div
                  class="w-10 h-10 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center mr-3"
                >
                  <i class="fas fa-hdd text-yellow-600 dark:text-yellow-400"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-900 dark:text-white">Storage</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">78% used</div>
                </div>
              </div>
              <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">⚠</div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-blue-100 dark:border-gray-700 overflow-hidden"
        >
          <div class="px-6 py-4 border-b border-blue-50 dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Recent Activity</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Latest system events and alerts
            </p>
          </div>
          <div class="divide-y divide-blue-50 dark:divide-gray-700">
            <% const recentActivities = [ { type: 'success', icon: 'fa-play', message: 'DVR "Main
            Building" started streaming', time: '2 minutes ago' }, { type: 'info', icon: 'fa-user',
            message: 'Admin user logged in', time: '15 minutes ago' }, { type: 'warning', icon:
            'fa-exclamation', message: 'Camera "Entrance" connection unstable', time: '1 hour ago'
            }, { type: 'success', icon: 'fa-stop', message: 'Stream "Parking Lot" stopped', time: '2
            hours ago' }, { type: 'info', icon: 'fa-sync', message: 'System health check completed',
            time: '3 hours ago' } ]; %> <% recentActivities.forEach(activity => { %>
            <div class="px-6 py-4 hover:bg-blue-50/30 dark:hover:bg-gray-700/30 transition-colors">
              <div class="flex items-start">
                <div
                  class="w-8 h-8 rounded-lg <%= activity.type === 'success' ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400' : activity.type === 'warning' ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' %> flex items-center justify-center mr-3 mt-1"
                >
                  <i class="fas <%= activity.icon %> text-xs"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-900 dark:text-white"><%= activity.message %></p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><%= activity.time %></p>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
        </div>
      </div>

      <!-- Analytics Summary -->
      <div
        class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/10 rounded-2xl p-6 border border-blue-200 dark:border-blue-800"
      >
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Analytics Summary</h3>
            <p class="text-gray-700 dark:text-gray-300">
              Your streaming infrastructure is operating at
              <span class="font-bold text-green-600 dark:text-green-400">optimal performance</span>
              . All systems are functional with
              <span class="font-bold text-blue-600 dark:text-blue-400"><%= active_streams %></span>
              active streams across
              <span class="font-bold text-blue-600 dark:text-blue-400">
                <%= activeDvrs?.length || 0 %>
              </span>
              DVR locations.
            </p>
          </div>
          <div class="flex items-center space-x-3">
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600 dark:text-green-400">
                <%= Math.round((active_streams / total_cameras) * 100) || 0 %>%
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Utilization Rate</div>
            </div>
            <button
              id="generate-report"
              class="btn-gradient text-white font-medium rounded-xl px-5 py-2.5 text-sm inline-flex items-center"
            >
              <i class="fas fa-file-alt mr-2"></i>
              Generate Report
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Integrated JavaScript -->
    <!-- Data Initialization Script -->
    <script nonce="<%= nonce %>">
      // Pass server-side data to analytics.js
      window.analyticsData = {
          dvrNames: <%- JSON.stringify(dvrs.map(dvr => dvr.dvr_name)) %>,
          activeStreamsData: <%- JSON.stringify(dvrs.map(dvr => {
              const activeDvr = activeDvrs.find(ad => ad.id === dvr.id);
              return activeDvr ? activeDvr.activeCameraCount || 0 : 0;
          })) %>,
          dvrs: <%- JSON.stringify(dvrs) %>,
          totalCameras: <%= total_cameras %>,
          activeCameras: <%= active_streams %>,
          totalDvrs: <%= typeof total_dvrs !== "undefined" ? total_dvrs : 0 %>,
          activeDvrsCount: <%= activeDvrs?.length || 0 %>
      };
    </script>

    <!-- Include the analytics.js file -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" nonce="<%= nonce %>"></script>
    <script src="/js/analytics.js" nonce="<%= nonce %>"></script>
    <script src="/js/topMenu.js" nonce="<%= nonce %>"></script>
  </body>
</html>
